<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mToken System v13.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://czp.dga.or.th/cportal/sdk/iu/v3/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding: 20px; }
        .debug-console { background-color: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; height: 300px; overflow-y: auto; white-space: pre-wrap; font-size: 0.85rem; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card p-4 shadow-sm border-0">
                <h3 class="text-center mb-4 text-primary fw-bold">mToken + Notification</h3>
                
                <div id="inputForm">
                    <div class="alert alert-light border">
                        <small>‚ÑπÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ <strong>userId</strong> ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Login ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Notification API</small>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">App ID</label>
                        <input type="text" id="appId" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">mToken</label>
                        <textarea id="mToken" class="form-control" rows="3"></textarea>
                    </div>
                    <button onclick="startLogin()" class="btn btn-primary w-100 py-2 fw-bold">üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (Login)</button>
                </div>

                <div id="resultArea" class="hidden mt-4">
                    <h5 class="fw-bold border-bottom pb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Logs)</h5>
                    <div class="debug-console mb-3" id="consoleOutput">Waiting...</div>
                    
                    <div id="notifySection" class="hidden bg-white p-3 rounded border">
                        <h6 class="fw-bold text-success">üîî ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Notification)</h6>
                        <div class="input-group">
                            <input type="text" id="notifyMsg" class="form-control" value="Hello from Test5! ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à">
                            <button onclick="sendNotify()" class="btn btn-warning text-dark fw-bold">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                        </div>
                    </div>

                    <button onclick="location.reload()" class="btn btn-secondary w-100 mt-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà / Login ‡πÉ‡∏´‡∏°‡πà</button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á Notify
    let currentUserId = null;
    let currentAppId = null;

    window.onload = function() {
        // Auto-Fill ‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ SDK
        const params = new URLSearchParams(window.location.search);
        if(params.has('appId')) document.getElementById('appId').value = params.get('appId');
        if(params.has('mToken')) document.getElementById('mToken').value = params.get('mToken');
        
        if(window.czpSdk) {
            try {
                const sdkAppId = window.czpSdk.getAppId();
                if(sdkAppId) document.getElementById('appId').value = sdkAppId;
            } catch(e) {}
        }
    }

    async function startLogin() {
        const appId = document.getElementById('appId').value;
        const mToken = document.getElementById('mToken').value;
        const consoleBox = document.getElementById('consoleOutput');

        // UI Transition
        document.getElementById('inputForm').classList.add('hidden');
        document.getElementById('resultArea').classList.remove('hidden');
        consoleBox.innerText = "‚è≥ Processing Login...";

        try {
            const res = await fetch('/test5/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ appId, mToken })
            });
            const result = await res.json();

            // ‡πÅ‡∏™‡∏î‡∏á Log Login
            let logText = `LOGIN STATUS: ${res.status}\n=================\n`;
            if(result.debug) {
                logText += `[STEP 1] GDX Token: ${result.debug.step1 ? '‚úÖ OK' : '‚ùå'}\n`;
                logText += `[STEP 2] Profile: ${result.debug.step2 ? '‚úÖ OK' : '‚ùå'}\n`;
                logText += `[STEP 3] DB Save: ${result.debug.step3 ? '‚úÖ OK' : '‚ùå'}\n`;
            }

            if(result.status === 'success') {
                logText += `\n‚úÖ SUCCESS: Welcome ${result.data.firstName}\n`;
                logText += `üîë UserID: ${result.data.userId}\n`;
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á Notification ‡∏ï‡πà‡∏≠
                currentUserId = result.data.userId;
                currentAppId = result.data.appId;
                
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° Notify
                document.getElementById('notifySection').classList.remove('hidden');
            } else {
                logText += `\nüî¥ ERROR: ${result.message}`;
            }
            consoleBox.innerText = logText;

        } catch (e) {
            consoleBox.innerText = `‚ùå Connection Error: ${e.message}`;
        }
    }

    async function sendNotify() {
        if(!currentUserId || !currentAppId) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö UserID ‡∏´‡∏£‡∏∑‡∏≠ AppID (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô)");
        
        const msg = document.getElementById('notifyMsg').value;
        const consoleBox = document.getElementById('consoleOutput'); // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡πà‡∏≠
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Log ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á
        consoleBox.innerText += `\n-----------------\n‚è≥ Sending Notification...\nMsg: "${msg}"\n`;

        try {
            const res = await fetch('/test5/notify/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    appId: currentAppId, 
                    userId: currentUserId, 
                    message: msg 
                })
            });
            const result = await res.json();
            
            if(result.success) {
                consoleBox.innerText += `‚úÖ NOTIFY SUCCESS!\nResult: ${JSON.stringify(result.result, null, 2)}`;
                alert("‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } else {
                consoleBox.innerText += `üî¥ NOTIFY FAILED: ${result.message}\nError: ${JSON.stringify(result.error)}`;
                alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: " + result.message);
            }

        } catch(e) {
            consoleBox.innerText += `‚ùå Network Error: ${e.message}`;
        }
    }
</script>
</body>
</html>