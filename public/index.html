<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mToken System v12.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://czp.dga.or.th/cportal/sdk/iu/v3/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding: 20px; }
        .debug-console { background-color: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card p-4 shadow-sm">
                <h3 class="text-center mb-4 text-primary fw-bold">mToken System (Full Option)</h3>
                
                <div id="inputForm">
                    <div class="mb-3">
                        <label class="fw-bold">App ID</label>
                        <input type="text" id="appId" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">mToken</label>
                        <textarea id="mToken" class="form-control" rows="3"></textarea>
                    </div>
                    <button onclick="startLogin()" class="btn btn-primary w-100 py-2">üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</button>
                </div>

                <div id="resultArea" class="hidden mt-4">
                    <h5 class="fw-bold border-bottom pb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h5>
                    <div class="debug-console mb-3" id="consoleOutput">Processing...</div>
                    
                    <div id="notifySection" class="hidden border-top pt-3">
                        <h6 class="fw-bold text-success">üîî ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h6>
                        <div class="d-flex gap-2">
                            <input type="text" id="notifyMsg" class="form-control" value="‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß">
                            <button onclick="sendNotify()" class="btn btn-warning text-dark fw-bold" style="min-width: 120px;">‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢!</button>
                        </div>
                        <small class="text-muted">*‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡πÉ‡∏ô App ‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ê (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</small>
                    </div>

                    <button onclick="location.reload()" class="btn btn-secondary w-100 mt-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    let currentUserCitizenId = null; // ‡πÄ‡∏Å‡πá‡∏ö CitizenID ‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        if(params.has('appId')) document.getElementById('appId').value = params.get('appId');
        if(params.has('mToken')) document.getElementById('mToken').value = params.get('mToken');
        
        if(window.czpSdk) {
            try {
                const sdkAppId = window.czpSdk.getAppId();
                if(sdkAppId) document.getElementById('appId').value = sdkAppId;
            } catch(e) {}
        }
    }

    async function startLogin() {
        const appId = document.getElementById('appId').value;
        const mToken = document.getElementById('mToken').value;
        const consoleBox = document.getElementById('consoleOutput');

        document.getElementById('inputForm').classList.add('hidden');
        document.getElementById('resultArea').classList.remove('hidden');
        consoleBox.innerText = "‚è≥ Connecting...";

        try {
            const res = await fetch('/test5/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ appId, mToken })
            });
            const result = await res.json();

            // ‡πÅ‡∏™‡∏î‡∏á Log
            let logText = `STATUS: ${res.status}\n=================\n`;
            if(result.debug) {
                logText += `[STEP 1] Token: ${result.debug.step1 ? '‚úÖ OK' : '‚ùå'}\n`;
                logText += `[STEP 2] Profile: ${result.debug.step2 ? '‚úÖ OK' : '‚ùå'}\n`;
                logText += `[STEP 3] DB: ${result.debug.step3 ? '‚úÖ OK' : '‚ùå'}\n`;
            }
            if(result.status === 'success') {
                logText += `\nüéâ SUCCESS: ${result.data.firstName} ${result.data.lastName}`;
                
                // ‡πÄ‡∏Å‡πá‡∏ö CitizenID ‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                currentUserCitizenId = result.data.citizenId;
                document.getElementById('notifySection').classList.remove('hidden');
            } else {
                logText += `\nüî¥ ERROR: ${result.message}`;
            }
            consoleBox.innerText = logText;

        } catch (e) {
            consoleBox.innerText = `‚ùå Error: ${e.message}`;
        }
    }

    async function sendNotify() {
        if(!currentUserCitizenId) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö Citizen ID");
        const msg = document.getElementById('notifyMsg').value;
        
        try {
            const res = await fetch('/test5/notify/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ citizenId: currentUserCitizenId, message: msg })
            });
            const result = await res.json();
            alert(result.status === 'success' ? "‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!" : "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: " + result.message);
        } catch(e) {
            alert("‚ùå Error: " + e.message);
        }
    }
</script>
</body>
</html>