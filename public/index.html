<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mToken System v5.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://czp.dga.or.th/cportal/sdk/iu/v3/sdk.js"></script>
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: 'Sarabun', sans-serif; }
        .version-badge { position: absolute; top: 10px; right: 10px; background: #000; color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; }
        .card { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .status-log { font-family: monospace; font-size: 0.85rem; color: #666; background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .debug-box { background: #1e1e1e; color: #00ff00; padding: 15px; font-family: monospace; font-size: 0.8rem; height: 300px; overflow-y: auto; white-space: pre-wrap; border-radius: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="version-badge">VERSION 5.0</div>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card p-4">
                <h4 class="text-center mb-3 text-primary fw-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (mToken)</h4>
                
                <div class="status-log" id="searchLog">
                    Checking Source...
                </div>

                <div id="manualForm" class="hidden">
                    <div class="alert alert-warning border-0 d-flex align-items-center">
                        <span class="me-2">‚ö†Ô∏è</span>
                        <small>‡πÑ‡∏°‡πà‡∏û‡∏ö mToken ‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ SDK (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î Developer)</small>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold form-label">App ID</label>
                        <input type="text" id="appId" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ App ID">
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold form-label">mToken</label>
                        <textarea id="mToken" class="form-control" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ mToken..."></textarea>
                    </div>
                    <button onclick="startLogin()" class="btn btn-primary w-100">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</button>
                </div>

                <div id="loadingScreen" class="hidden text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <h5>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</h5>
                    <p class="text-muted small">Sending data to Backend API</p>
                </div>

                <div id="resultScreen" class="hidden">
                    <h5 class="border-bottom pb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</h5>
                    <div id="consoleBox" class="debug-box">Waiting...</div>
                    <button onclick="location.reload()" class="btn btn-secondary w-100 mt-3">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    window.onload = async function() {
        await checkSources();
    }

    async function checkSources() {
        const log = document.getElementById('searchLog');
        let foundAppId = null;
        let foundMToken = null;

        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ URL
        log.innerHTML = "üîç 1. Checking URL Parameters... ";
        const params = new URLSearchParams(window.location.search);
        if (params.has('appId') && params.has('mToken')) {
            foundAppId = params.get('appId');
            foundMToken = params.get('mToken');
            log.innerHTML += "<span class='text-success'>FOUND ‚úÖ</span>";
        } else {
            log.innerHTML += "<span class='text-danger'>NOT FOUND ‚ùå</span><br>";
        }

        // 2. ‡πÄ‡∏ä‡πá‡∏Ñ SDK (‡∏ñ‡πâ‡∏≤ URL ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠)
        if (!foundAppId) {
            log.innerHTML += "üîç 2. Checking 'TangRat' SDK... ";
            if (window.czpSdk) {
                try {
                    foundAppId = window.czpSdk.getAppId();
                    foundMToken = window.czpSdk.getToken();
                    if(foundAppId) log.innerHTML += "<span class='text-success'>FOUND ‚úÖ</span>";
                    else log.innerHTML += "<span class='text-danger'>EMPTY ‚ùå</span>";
                } catch(e) {
                    log.innerHTML += "<span class='text-danger'>ERROR ‚ùå</span>";
                }
            } else {
                log.innerHTML += "<span class='text-danger'>NOT DETECTED ‚ùå</span> (Not inside App)";
            }
        }

        // ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à
        if (foundAppId && foundMToken) {
            log.innerHTML += "<br>üöÄ Auto-Login Starting...";
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏•‡∏á Form ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢
            document.getElementById('appId').value = foundAppId;
            document.getElementById('mToken').value = foundMToken;
            startLogin(); 
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢ -> ‡πÄ‡∏õ‡∏¥‡∏î Manual Form
            document.getElementById('manualForm').classList.remove('hidden');
        }
    }

    async function startLogin() {
        const appId = document.getElementById('appId').value;
        const mToken = document.getElementById('mToken').value;
        const consoleBox = document.getElementById('consoleBox');

        // ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById('manualForm').classList.add('hidden');
        document.getElementById('searchLog').classList.add('hidden');
        document.getElementById('loadingScreen').classList.remove('hidden');

        try {
            const response = await fetch('/test5/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ appId, mToken })
            });
            
            const result = await response.json();
            
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');

            let logText = `STATUS: ${response.status}\n`;
            logText += `==============================\n`;
            
            if (result.debug) {
                logText += `[STEP 1] GDX Token: ${result.debug.step1_gdx_token ? '‚úÖ OK' : '‚ùå FAIL'}\n`;
                if(result.debug.step1_gdx_token) logText += `   > ${result.debug.step1_gdx_token.substring(0, 20)}...\n`;
                
                logText += `[STEP 2] Deproc Data: ${result.debug.step2_deproc_data ? '‚úÖ OK' : '‚ùå FAIL'}\n`;
                if(result.debug.step2_deproc_data) logText += `   > ${JSON.stringify(result.debug.step2_deproc_data).substring(0, 50)}...\n`;
                
                logText += `[STEP 3] DB Saved: ${result.debug.step3_db_saved ? '‚úÖ YES' : '‚ùå NO'}\n`;
            }

            if (result.status === 'success') {
                logText += `\nüü¢ SUCCESS! Welcome: ${result.data.firstName} ${result.data.lastName}`;
            } else {
                logText += `\nüî¥ FAILED: ${result.message}\n`;
                if(result.api_response) logText += `API ERROR: ${JSON.stringify(result.api_response, null, 2)}`;
            }

            consoleBox.innerText = logText;

        } catch (e) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            consoleBox.innerText = "‚ùå CONNECTION ERROR:\n" + e.message;
        }
    }
</script>

</body>
</html>