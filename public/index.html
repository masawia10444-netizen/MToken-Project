<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mToken Authentication | e-Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-icon { font-size: 3rem; margin-bottom: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card p-4 text-center">
                <div id="loadingSection">
                    <div class="spinner-border text-primary status-icon" role="status"></div>
                    <h4>กำลังยืนยันตัวตน...</h4>
                    <p class="text-muted">กรุณารอสักครู่ ระบบกำลังตรวจสอบ mToken</p>
                </div>

                <div id="successSection" style="display: none;">
                    <div class="status-icon text-success">✅</div>
                    <h4 class="text-success">ยินดีต้อนรับ</h4>
                    <h5 id="userName" class="fw-bold mt-3">-</h5>
                    <p class="text-muted mt-2">เข้าสู่ระบบสำเร็จ</p>
                </div>

                <div id="errorSection" style="display: none;">
                    <div class="status-icon text-danger">❌</div>
                    <h4 class="text-danger">เกิดข้อผิดพลาด</h4>
                    <p id="errorMessage" class="text-muted">ไม่สามารถยืนยันตัวตนได้</p>
                    <button class="btn btn-outline-secondary mt-3" onclick="location.reload()">ลองใหม่อีกครั้ง</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // URL ของ API หลังบ้านเรา (Relative Path เพราะอยู่ Domain เดียวกัน)
    const API_URL = '/test5/auth/login';

    async function processLogin() {
        // 1. ดึงค่า appId และ mToken (รองรับทั้ง URL Param และ SDK)
        const params = new URLSearchParams(window.location.search);
        let appId = params.get('appId');
        let mToken = params.get('mToken');

        // ถ้าไม่มีใน URL ลองดูว่ามี SDK ไหม (เผื่ออนาคต)
        if (!appId && window.czpSdk) {
            try {
                appId = window.czpSdk.getAppId();
                mToken = window.czpSdk.getToken();
            } catch (e) { console.log('SDK not found'); }
        }

        // ถ้ายังไม่มีค่าอีก -> แสดง Error
        if (!appId || !mToken) {
            showError('ไม่พบข้อมูล appId หรือ mToken ในลิงก์');
            return;
        }

        // 2. ส่งค่าไปให้ Backend (Node.js)
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ appId, mToken })
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                // 3. สำเร็จ -> แสดงชื่อ
                showSuccess(`${result.data.firstName} ${result.data.lastName}`);
            } else {
                // ไม่สำเร็จ -> แสดง Error จาก Server
                throw new Error(result.message || 'Verification Failed');
            }
        } catch (error) {
            console.error('Login Error:', error);
            showError('การเชื่อมต่อล้มเหลว หรือ Token หมดอายุ');
        }
    }

    function showSuccess(name) {
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('successSection').style.display = 'block';
        document.getElementById('userName').innerText = name;
    }

    function showError(msg) {
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').innerText = msg;
    }

    // เริ่มทำงานทันทีที่เปิดหน้าเว็บ
    window.onload = processLogin;
</script>

</body>
</html>