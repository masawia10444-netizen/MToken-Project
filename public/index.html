<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mToken System Debugger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://czp.dga.or.th/cportal/sdk/iu/v3/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding: 20px; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 12px; }
        .debug-console { 
            background-color: #1e1e1e; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 6px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.85rem; 
            height: 350px; 
            overflow-y: auto;
            white-space: pre-wrap; /* ‡∏à‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
        }
        .hidden { display: none !important; }
        .btn-primary { background-color: #0d6efd; padding: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card p-4">
                <h3 class="text-center mb-4 text-primary">üõ†Ô∏è mToken Debugger</h3>
                
                <div id="inputForm">
                    <div class="alert alert-warning border-0">
                        <small>‚ÑπÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö API (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Token ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å GDX ‡πÉ‡∏´‡πâ‡∏î‡∏π)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">App ID</label>
                        <input type="text" id="appId" class="form-control form-control-lg" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ App ID">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">mToken</label>
                        <textarea id="mToken" class="form-control" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ mToken ‡∏¢‡∏≤‡∏ß‡πÜ..."></textarea>
                    </div>
                    <button onclick="startLogin()" class="btn btn-primary w-100 shadow-sm">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Start Debug)</button>
                </div>

                <div id="resultArea" class="hidden mt-3">
                    <h5 class="fw-bold border-bottom pb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Logs)</h5>
                    
                    <div class="debug-console" id="consoleOutput">Waiting for response...</div>

                    <div class="mt-3 text-center">
                        <button onclick="location.reload()" class="btn btn-secondary w-100">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï (Reset)</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠ SDK ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        if(params.has('appId')) document.getElementById('appId').value = params.get('appId');
        if(params.has('mToken')) document.getElementById('mToken').value = params.get('mToken');
        
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ SDK ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡πÉ‡∏™‡πà
        if(window.czpSdk) {
            try {
                const sdkAppId = window.czpSdk.getAppId();
                if(sdkAppId) document.getElementById('appId').value = sdkAppId;
            } catch(e) { console.log('SDK not ready'); }
        }
    }

    async function startLogin() {
        const appId = document.getElementById('appId').value;
        const mToken = document.getElementById('mToken').value;
        const consoleBox = document.getElementById('consoleOutput');

        // ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById('inputForm').classList.add('hidden');
        document.getElementById('resultArea').classList.remove('hidden');
        
        consoleBox.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server...\n(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)";

        try {
            const response = await fetch('/test5/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ appId, mToken })
            });

            const result = await response.json();
            
            // --- ‡∏à‡∏±‡∏î Format Log ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ---
            let logText = `HTTP Status: ${response.status}\n`;
            logText += `----------------------------------------\n`;
            
            if (result.debug) {
                // ‡πÇ‡∏ä‡∏ß‡πå Token ‡∏à‡∏≤‡∏Å GDX
                logText += `[STEP 1] GDX Token:\n${result.debug.step1_gdx_token || '‚ùå FAILED (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Token)'}\n\n`;
                
                // ‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Deproc
                if (result.debug.step2_deproc_data) {
                    logText += `[STEP 2] Deproc Raw Response:\n${JSON.stringify(result.debug.step2_deproc_data, null, 2)}\n\n`;
                } else {
                    logText += `[STEP 2] Deproc: ‚ùå Skipped or Failed\n\n`;
                }
                
                // ‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ DB
                logText += `[STEP 3] Database Save: ${result.debug.step3_db_saved ? '‚úÖ OK' : '‚ùå Failed'}\n`;
            }

            if (result.status === 'error') {
                logText += `\nüî¥ ERROR MESSAGE: ${result.message}\n`;
                if (result.api_response) {
                     logText += `üî¥ API DETAILS:\n${JSON.stringify(result.api_response, null, 2)}`;
                }
            } else {
                logText += `\nüü¢ FINAL STATUS: SUCCESS\n`;
                logText += `User: ${result.data.firstName} ${result.data.lastName}`;
            }

            consoleBox.innerText = logText;

        } catch (error) {
            consoleBox.innerText = `‚ùå NETWORK ERROR:\n${error.message}`;
        }
    }
</script>

</body>
</html>